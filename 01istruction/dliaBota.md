# Логика и структура Telegram-интеграции (v3.0 — Vercel Native)

Интеграция переведена на Vercel Postgres и разделена на **Бот-ассистент** (текстовый интерфейс и уведомления) и **Mini App / Личный кабинет** (визуальный интерфейс).

## 1. Текущие возможности (Что уже работает)

### 1.1. Бот-ассистент (@OtelShinBot)
*   **Авторизация:** Привязка Telegram ID к базе CRM через кнопку "Поделиться контактом". Автоматический поиск клиента по номеру телефона в Postgres.
*   **Главное меню:** Интерактивные кнопки (Запись, ЛК, Цены, Партнеры, Помощь).
*   **Сбор лидов (Signup Flow):** Пошаговый сбор данных (Телефон -> Авто -> Район) и отправка уведомления администратору.
*   **Текстовый Личный Кабинет:** Просмотр статуса, номера договора и даты окончания прямо в чате.
*   **Заявка на выдачу:** Кнопка "Забрать шины" запрашивает дату/время текстом и уведомляет админа.
*   **Калькулятор продления:** Интерактивный выбор срока (1, 6, 12 мес) и опции "с дисками", расчет итоговой суммы текстом.

### 1.2. Mini App (Личный Кабинет)
*   **Умный вход:** Если пользователь не найден в базе, Mini App показывает `NewUserForm` с анимированными преимуществами и формой захвата телефона (Лид).
*   **Dashboard клиента:** Визуальное отображение статуса ("На складе"), номера договора и "прогресс-бара" срока хранения.
*   **Детализация:** Список параметров колес (авто, размер, ячейка на складе).
*   **Реферальная система:** Генерация и шеринг ссылки через `openTelegramLink` для приглашения друзей.
*   **UI/UX:** Поддержка темной темы Telegram, Haptic Feedback (виброотклик) при отправке заявок.

---

## 2. ПЛАН ДОРАБОТОК (Этапы реализации)

### Этап 1: Автоматизация уведомлений (Cron & Push)
*Цель: Бот должен сам напоминать клиенту о сроках, а не ждать команды.*
1.  [ ] **Настройка Vercel Cron:** Создание скрипта `api/cron-reminders.ts` для ежедневной проверки сроков.
2.  [ ] **Push за 7 дней:** Автоматическое сообщение клиенту: "Ваш срок хранения истекает через неделю. Продлим?".
3.  [ ] **Уведомление в день X:** Сообщение о переходе договора в статус "Просрочен".
4.  [ ] **Авто-чек после CRM:** Когда менеджер создает заказ в CRM, бот автоматически присылает клиенту детали заказа и кнопку входа в Mini App.

### Этап 2: Финансы и Оплата (E-commerce)
*Цель: Дать возможность клиенту оплатить продление без звонка менеджеру.*
1.  [ ] **Интеграция Telegram Payments:** Настройка `bot.ts` для приема платежей (через ЮKassa/Robokassa).
2.  [ ] **Продление в Mini App:** Добавление кнопки "Оплатить" в визуальный интерфейс ЛК.
3.  [ ] **Генерация счетов:** Автоматическая отправка Invoice в чат после нажатия "Продлить".
4.  [ ] **Обработка успешной оплаты:** Автоматическое обновление даты `Окончание` в Postgres после подтверждения платежа.

### Этап 3: Визуальный контент и Фотоотчеты
*Цель: Повысить доверие, показывая реальные фото шин.*
1.  [ ] **Интеграция с Google Drive API:** Проксирование изображений из CRM в Mini App (сейчас фото видны только в CRM).
2.  [ ] **Галерея в ЛК:** Добавление вкладки "Фотоотчет" в Mini App, где клиент видит свои шины на складе.
3.  [ ] **Загрузка актов:** Возможность скачать PDF-версию договора/акта приема прямо из бота.

### Этап 4: Лояльность и Масштабирование
*Цель: Стимулировать повторные продажи и сарафанное радио.*
1.  [ ] **Система лояльности:** Начисление "бонусных месяцев" в Postgres за приглашенных друзей.
2.  [ ] **Запись на шиномонтаж:** Полноценный календарь в Mini App для выбора времени у партнеров.
3.  [ ] **Оценка сервиса:** Бот просит поставить оценку (1-5) после выдачи шин; плохие оценки (1-3) сразу пересылаются админу.

---

## 3. Контроль выполнения
*   **Архитектура:** Все новые функции должны использовать `api/crm.ts` как единый контроллер базы Postgres.
*   **Безопасность:** Доступ к Mini App строго через проверку `initData` от Telegram.
*   **Логирование:** Все действия бота (особенно платежи) должны дублироваться в таблицу `history`.
