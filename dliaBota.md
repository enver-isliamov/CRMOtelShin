
START
 ├─ Записаться на хранение
 │   ├─ Телефон
 │   ├─ Номер авто (опц.)
 │   ├─ Район (опц.)
 │   └─ Заявка → Менеджер: Принять / Уточнить
 │
 ├─ Личный кабинет
 │   ├─ Продлить хранение
 │   │   ├─ Выбор срока (1–12)
 │   │   ├─ Диски: Да/Нет (+100р/мес)
 │   │   ├─ Стоимость
 │   │   ├─ Доп. услуги
 │   │   └─ Оплата
 │   │
 │   ├─ Забрать шины
 │   │   ├─ Инфо
 │   │   ├─ Адрес
 │   │   ├─ Время
 │   │   └─ Заявка менеджеру
 │   │
 │   ├─ Шиномонтаж
 │   │   ├─ Партнёрские
 │   │   └─ Выездной
 │   │
 │   ├─ Реферальная программа
 │   └─ Связаться с менеджером
 │
 ├─ Цены
 ├─ Почему мы
 ├─ Шиномонтаж
 ├─ Партнёрские сервисы
 └─ Связаться с менеджером
 
*************************
### ТЕКУЩАЯ ЛОГИКА РАБОТЫ БОТА (Vercel Native)

1. **Технологический стек:**
   - Среда исполнения: Vercel Serverless Functions (Node.js).
   - База данных: Vercel Postgres.
   - API: Telegram Bot API (Webhooks).

2. **Авторизация:**
   - По умолчанию бот ищет пользователя в таблице `clients` по `Chat ID`.
   - Если пользователь новый или ID не совпадает, предлагается кнопка **"Привязать номер телефона"**.
   - Номер телефона получается через стандартный механизм Telegram (`request_contact`), что гарантирует его подлинность.
   - При совпадении номера с записью в CRM, `Chat ID` автоматически записывается в базу, открывая доступ к ЛК.

3. **Личный кабинет (ЛК):**
   - Данные подгружаются в реальном времени из Postgres.
   - Клиент видит: ФИО, Госномер, Номер договора, Срок окончания хранения, Историю своих заказов.
   - **Продление:** Работает через калькулятор состояний. Бот запоминает выбор пользователя (срок, диски) в таблице `bot_sessions` и выдает итоговую сумму.

4. **Система заявок:**
   - Любое критическое действие (Заявка на хранение, Заявка на выдачу) формирует отчет и отправляет его в чат администратора (`ADMIN_CHAT_ID`).
   - Администратор получает: ФИО клиента, контактные данные, суть заявки и Chat ID для быстрой связи.

5. **Интеграция с CRM:**
   - Бот и сайт CRM используют одну и ту же базу данных.
   - Уведомления, отправленные из веб-интерфейса CRM, мгновенно доставляются ботом.
   - При отправке "Чека" или "Деталей заказа" бот автоматически добавляет инлайновые кнопки для перехода в ЛК.

6. **Отработка ошибок:**
   - Реализована защита от повторных запросов (Idempotency).
   - Все текстовые команды нормализуются (регистр, лишние пробелы).
   - В случае сбоя БД или сервера бот отправляет вежливое уведомление о временных работах.
   - Понять как реагирует бот если пользователь отправляет произвольное сообщение не по теме и т.д.
