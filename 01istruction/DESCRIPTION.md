# Описание проекта: CRM-система для Шинного Хранения (Tire Storage CRM)

**Версия:** 1.2.0

## 1. Назначение и Цели

**Tire Storage CRM** — это комплексное веб-приложение, разработанное для автоматизации и упрощения бизнес-процессов компании, занимающейся сезонным хранением автомобильных шин. Основная цель системы — предоставить удобный инструмент для управления клиентской базой, отслеживания заказов, контроля финансов и автоматизации коммуникаций с клиентами.

Приложение построено на современной архитектуре с использованием Google Sheets в качестве бэкенда, что делает его доступным, легко масштабируемым и не требующим сложной серверной инфраструктуры.

## 2. Основной функционал

### 2.1. Дашборд (Панель мониторинга)
Централизованное представление ключевых бизнес-метрик:
- **Финансовые показатели:** Отображение общей выручки, текущего месячного дохода (в реальном времени) и общей суммы задолженностей.
- **Клиентская база:** Общее количество активных клиентов.
- **Список должников:** Быстрый доступ к клиентам с просроченной оплатой с возможностью отправки напоминания в один клик.
- **Список "напоминаний":** Отображение клиентов, у которых срок хранения подходит к концу в ближайшие 30 дней, с возможностью отправки уведомления и создания события в Google Календаре.

### 2.2. Управление клиентами
- **Единая база:** Просмотр, поиск и фильтрация всех клиентов в удобной табличной форме.
- **Карточка клиента:** Детальная информация о каждом клиенте, включая контактные данные, информацию об автомобиле, историю всех заказов и прикрепленные фотографии.
- **Массовые действия:** Возможность выбора нескольких клиентов для массовой рассылки или удаления.
- **Сохраненные виды:** Пользователи могут сохранять свои настройки фильтров и сортировки для быстрого доступа к нужным сегментам базы.

### 2.3. Создание и управление заказами
- **Гибкая форма:** Удобная форма для добавления нового клиента или оформления нового заказа для уже существующего.
- **Автоматические расчеты:** Система автоматически рассчитывает стоимость хранения, дату окончания и дату напоминания на основе введенных данных.
- **Управление услугами:** Легкое добавление дополнительных услуг (мойка, упаковка, вывоз) к заказу.
- **Архивация:** При оформлении нового заказа для старого клиента, предыдущий заказ автоматически переносится в архив, сохраняя полную историю взаимодействия.

### 2.4. Фотографии
- **Визуальное подтверждение:** Возможность загружать фотографии шин клиента через drag-and-drop или напрямую с камеры устройства.
- **Интеграция с Google Drive:** Все фотографии надежно хранятся в специальной папке на Google Диске пользователя, структурированные по номеру договора.

### 2.5. Автоматизация и уведомления
- **Интеграция с Telegram:** Настройка и отправка автоматических уведомлений клиентам и менеджерам через Telegram-бота.
- **Шаблоны сообщений:** Создание и редактирование шаблонов для различных типов уведомлений (напоминание о долге, об окончании хранения и т.д.) с использованием плейсхолдеров (например, `{{Имя клиента}}`).

### 2.6. Настройки
- **Гибкая конфигурация:** Управление всеми ключевыми параметрами системы, включая токен Telegram-бота, ID администраторов и менеджеров, а также URL Google Apps Script.
- **Управление мастерами:** Добавление и редактирование профилей мастеров шиномонтажа с возможностью быстрой записи клиента на услугу и отправки уведомления мастеру.

## 3. Технологический стек

- **Фронтенд:**
  - **React (v19):** Современная библиотека для построения пользовательских интерфейсов.
  - **TypeScript:** Строгая типизация для повышения надежности и поддерживаемости кода.
  - **Tailwind CSS:** Утилитарный CSS-фреймворк для быстрой и адаптивной верстки.
  - **React Router:** Для навигации в одностраничном приложении (SPA).

- **Бэкенд:**
  - **Google Sheets:** Используется в качестве гибкой и доступной базы данных.
  - **Google Apps Script (GAS):** Серверная логика, развернутая как веб-приложение, которое обрабатывает запросы от фронтенда, взаимодействует с таблицами и внешними API (Telegram, Google Drive).

- **API:**
  - **REST-подобный интерфейс:** Фронтенд общается с GAS через `POST` запросы, отправляя JSON-объекты с указанием необходимого действия (`action`).
---PROMPT_SEPARATOR---
# Промт для воссоздания CRM

System Prompt:
You are a world-class senior frontend engineer specializing in React, TypeScript, and Google Cloud integrations. Your task is to build a comprehensive CRM application for a tire storage business from scratch.

**Название Приложения:** Tire Storage CRM (CRM-OtelShun.ru)

**Основные Технологии:**
*   **Frontend:** React, TypeScript, React Router, Tailwind CSS.
*   **Backend:** Google Sheets acting as a database, accessed via a Google Apps Script (GAS) deployed as a web app.
*   **API Communication:** The frontend communicates with the GAS URL by sending `POST` requests with a JSON payload specifying the desired `action`.

**Ключевые Особенности и Структура UI:**

**1. Аутентификация:**
*   Аутентификация **отсутствует**. Приложение сразу загружается с правами пользователя `Admin`. Нет страницы входа или защищенных маршрутов.

**2. Основной Макет:**
*   **Десктоп:** Двухколоночный макет с фиксированной боковой панелью слева и основным контентом справа.
    *   Боковая панель содержит логотип, навигационные ссылки (Дашборд, Клиенты, Добавить, Настройки), переключатель темы (`ThemeSwitcher`) и кнопку выхода (декоративную).
*   **Мобильные устройства:** Одноколоночный макет.
    *   Заголовок с логотипом, переключателем темы и кнопкой выхода.
    *   Область основного контента.
    *   Фиксированная нижняя навигационная панель с иконками для Дашборда, Клиентов, Добавления и Настроек.
*   **Тема:** Реализована поддержка светлой и темной темы с использованием `dark:` вариантов Tailwind и класса на элементе `<html>`. Предпочтение темы хранится в `localStorage`.
*   **Эмулятор вида:** В правом нижнем углу есть кнопка `DevViewToggle` для переключения между десктопным и эмулируемым мобильным видом.

**3. Модели Данных (`types.ts`):**
*   Определены интерфейсы для `Client`, `Settings`, `MessageTemplate`, `Master`, `AppLog`, `SavedView` и др., чтобы моделировать данные, хранящиеся в Google Sheets.
*   Интерфейс `Client` включает поля для контактной информации, данных автомобиля, деталей заказа (даты, цена, услуги), места хранения, финансового статуса и `photoUrls: string[]`.

**4. Бэкенд (Google Apps Script):**
*   **Версия скрипта: 1.9.9**
*   Функция `doPost(e)` действует как единая конечная точка API.
*   `routeAction` обрабатывает `action` из тела запроса: `getclients`, `add`, `update`, `reorder`, `sendMessage`, `uploadfile`, `getlogs`, `getmasters`, `gettemplates` и т.д.
*   Реализованы CRUD-операции с листами Google Sheets: `WebBase`, `Archive`, `Шаблоны сообщений`, `мастера`, `History`, `Logs`.
*   **`reorderClient`:** Критическая функция, которая атомарно архивирует старый заказ клиента и обновляет его строку в `WebBase` данными нового заказа. Использует `LockService` для предотвращения гонки данных.
*   **`uploadFile`:** Принимает данные файла в Base64, декодирует их и сохраняет в структуру папок на Google Диске: `TireCRMPhotos/[НомерДоговора_ИмяКлиента]/`. Возвращает публичный URL файла.
*   **`sendMessage`:** Использует `UrlFetchApp` для отправки HTML-сообщений через Telegram Bot API.
*   **Логирование:** Функции `logError` и `logHistory` записывают данные в листы `Logs` и `History`.

**5. Сервис API (`services/api.ts`):**
*   Создан типизированный API-клиент на фронтенде для связи с GAS.
*   Включены функции для каждого действия бэкенда.
*   Обрабатывается парсинг данных (например, `parseCurrency`, `parseDate`).

**6. Компоненты и Страницы:**

*   **Дашборд (`/`):**
    *   Отображаются ключевые метрики в UI-компонентах `Card`:
        *   `TotalEarningsCounter`: "Всего заработано" с живым подсчетом дохода на основе прошедшего времени хранения для активных контрактов (pro-rata).
        *   `LiveIncomeCounter`: "Доход в реальном времени" с переключателем периода (сек, мин, час, день и т.д.).
        *   `TotalRevenueCard`: Общая сумма всех заказов (активных и архивных).
        *   StatCard: Карточки для "Активных клиентов" и "Общего долга".
    *   Два списка в `Card`: `ExpiringClientsList` (окончание в течение 30 дней) и `DebtorsList` (должники). Оба имеют кнопку "Напомнить", отправляющую шаблонное сообщение.

*   **Просмотр Клиентов (`/clients`):**
    *   Отображение клиентов в адаптивной таблице.
    *   Реализован поиск, сортировка по клику на заголовок столбца и фильтрация (по статусу, складу, наличию долга).
    *   **"Сохраненные виды"**: Пользователи могут сохранять комбинации фильтров/сортировки и загружать их.
    *   Клик по строке открывает `ClientDetailModal` с полной информацией.
    *   **Модальное окно деталей клиента** имеет вкладки: "Детали", "История заказов" (`OrderHistory`), "Фото" (`PhotoGallery`).
    *   Окно позволяет редактировать данные, отправлять сообщения, удалять клиента и инициировать **"Новый заказ"** (запуск `reorder` flow).

*   **Добавление Клиента (`/add-client`):**
    *   Комплексная форма для добавления нового клиента или нового заказа для существующего (reorder).
    *   Форма разделена на `Card`: "Клиент и Автомобиль", "Шины и Услуги", "Финансы".
    *   Автоматические расчеты: номер договора (`generateContractNumber`), даты, общая стоимость.
    *   Компонент `SmartTireInput` для раздельного ввода бренда, модели и размеров шин.
    *   Компонент `ImageUpload` с поддержкой drag-and-drop и захвата с камеры.
    *   При отправке формы сначала загружаются фото, затем выполняется один вызов API (`addClient` или `reorderClient`), после чего отправляются уведомления администраторам/менеджерам.

*   **Настройки (`/settings`):**
    *   Интерфейс с вкладками:
        *   **Основные:** Поля для URL GAS, токена Telegram, Chat ID. Есть кнопка "Проверить соединение".
        *   **Шаблоны:** Управление шаблонами сообщений с помощью `VisualEditor` (простой WYSIWYG-редактор).
        *   **Мастера:** CRUD для мастеров. Возможность записать клиента к мастеру с отправкой уведомления в Telegram.
        *   **Логи:** Просмотр системных логов с листа `Logs`.
        *   **Настройка GAS:** Пошаговая инструкция по настройке, включая полный код скрипта с кнопкой "Копировать".
        *   **О проекте:** Информация о приложении и раскрывающиеся списки с подробным описанием функционала и этим промтом.
