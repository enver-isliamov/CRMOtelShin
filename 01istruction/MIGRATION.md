# План миграции: Параллельный запуск (Vercel Native)

Этот документ описывает процесс перехода с архитектуры **Google Sheets (Legacy)** на **Vercel Postgres (Native)**.

## Статус проекта: [В ПРОЦЕССЕ]
*   **Бэкенд:** Node.js (Vercel Functions)
*   **База данных:** Vercel Postgres (SQL)
*   **Фронтенд:** React 19 (Vite)

---

## Этап 1: Инфраструктура и БД [ВЫПОЛНЕНО]
- [x] Создать проект в Vercel и подключить репозиторий.
- [x] Создать Storage -> Postgres в панели Vercel.
- [x] Привязать базу к проекту (Environment Variables: `POSTGRES_URL`).
- [x] Реализовать `api/setup.ts` для автоматического создания таблиц.
- [x] Выполнить первичную инициализацию (переход по `/api/setup`).

## Этап 2: Перенос серверной логики (API) [ВЫПОЛНЕНО]
- [x] Создать единый обработчик `api/crm.ts` (аналог `Code.gs`).
- [x] Реализовать CRUD операции (get, add, update, delete) для SQL.
- [x] **FIX:** Исправить ошибку SSL сертификата (нормализация URL).
- [x] **FIX:** Исправить ошибку `Unknown action: undefined` (надежный парсинг JSON в теле запроса).
- [x] Реализовать логику архивации (`reorder`) на стороне SQL.
- [x] Реализовать системное логирование и историю действий в БД.

## Этап 3: Миграция данных [ВЫПОЛНЕНО]
- [x] Создать вкладку "Миграция" в настройках CRM.
- [x] Реализовать функцию `fetchDataForMigration` (выгрузка всего из GAS).
- [x] Реализовать пакетную загрузку в Postgres (Clients, Archive, Masters, Templates).
- [x] Проверить целостность данных после переноса.

## Этап 4: Telegram Бот и Mini App [В ПРОЦЕССЕ]
- [x] Создать `api/bot.ts` на основе логики `Bot.gs`.
- [x] Перенести состояния сессий в таблицу `bot_sessions`.
- [x] Реализовать авторизацию в Mini App через `get_client_by_chatid` в Postgres.
- [x] Реализовать сбор лидов через форму для новых пользователей.
- [ ] **КРИТИЧЕСКИЙ ШАГ:** Переключить Webhook бота на Vercel (кнопка в Опциях).
- [ ] Тестирование всех кнопок меню бота в режиме Postgres.

## Этап 5: Расширенные интеграции и Автоматизация [НЕ ВЫПОЛНЕНО]
- [ ] **Интеграция с Google Drive:** 
    *   Сейчас CRM ищет фото на Диске через GAS. 
    *   Нужно реализовать Proxy-запросы к Google Drive API из `api/crm.ts` для отображения фото в Mini App.
- [ ] **Vercel Cron (Уведомления):**
    *   Настроить `vercel.json` для ежедневного запуска скрипта проверки сроков.
    *   Реализовать рассылку уведомлений об окончании хранения (за 7 дней).
- [ ] **Платежи:**
    *   Интеграция Telegram Payments (Invoice) для онлайн-продления.

## Этап 6: Завершение и отключение GAS [ПЛАН]
1.  Переключить `apiMode` в настройках на `VERCEL` для всех пользователей.
2.  Проверить, что новые заказы создаются в Postgres.
3.  Отключить развертывание (Deploy) в Google Apps Script.
4.  Использовать Google Таблицу только как бэкап (экспорт из Postgres).

---

## Технические заметки для разработчика
*   **SSL Issue:** Библиотека `pg` конфликтует с параметрами `sslmode=verify-full` в строке подключения Vercel. Используется принудительная очистка URL перед `new Pool()`.
*   **Parsing Issue:** Обработчики API теперь принимают данные даже если `Content-Type` не указан верно, пытаясь распарсить строку в JSON.
*   **Security:** Все запросы к `/api/crm` должны в будущем проверяться на наличие заголовка авторизации или проверять `initData` Telegram.
